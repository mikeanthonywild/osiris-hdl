/*
 * interrupt.c
 *
 * Author: Mike Wild <m.a.wild@se12.qmul.ac.uk>
 * Date: 24th March 2016
 *
 * Helper functions for setting up interrupts.
 *
 */

/***************************** Include Files *********************************/
#include "interrupt.h"
#include "xscugic.h"

/************************** Constant Definitions *****************************/


/**************************** Type Definitions *******************************/


/***************** Macros (Inline Functions) Definitions *********************/


/************************** Variable Definitions *****************************/
XScuGic g_int_ctrl;
static XScuGic_Config *int_ctrl_cfg_p;

/************************** Function Prototypes ******************************/


/*****************************************************************************/
int init_interrupts() {
	/*
	Xil_ExceptionInit(); // Only needed for Microblaze + PPC?

	int_ctrl_cfg_p = XScuGic_LookupConfig(XPAR_SCUGIC_0_DEVICE_ID);
	status = XScuGic_CfgInitialize(&int_ctl, int_ctl_cfg, int_ctl_cfg->CpuBaseAddress);
	if (status != XST_SUCCESS) {
		xil_printf("SCUGIC init failed");
		return status;
	}

	// Connect interrupt controller hardware driver
	Xil_ExceptionRegisterHandler(XIL_EXCEPTION_ID_IRQ_INT, (Xil_ExceptionHandler) XScuGic_InterruptHandler, &int_ctl);
	*/

	return XST_SUCCESS;
}


int create_interrupt(XScuGic *instance_p, u32 int_id, u8 priority, u8 trigger, Xil_InterruptHandler isr, void *callback_ref) {
    int status;

    // Connect interrupt controller hardware driver
    status = XScuGic_Connect(instance_p, int_id, isr, callback_ref);
    if (status != XST_SUCCESS) {
        return XST_FAILURE;
    }

    status = XScuGic_SetPriorityTriggerType(instance_p, int_id, priority, trigger);
    if (status != XST_SUCCESS) {
        return XST_FAILURE;
    }

    status = XScuGic_Enable(instance_p, int_id);
    if (status != XST_SUCCESS) {
        return XST_FAILURE;
    }

    return XST_SUCCESS;
}
